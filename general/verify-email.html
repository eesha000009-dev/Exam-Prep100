<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/images/logo.png" />

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Owluminate - Verify Email</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="modernized.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <style>
    .auth-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-md);
      background: linear-gradient(135deg, var(--light) 0%, #e2e8f0 100%);
    }
    
    .auth-container {
      width: 100%;
      max-width: 460px;
    }
    
    .auth-card {
      background: #fff;
      border-radius: var(--radius-xl);
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: var(--spacing-xl);
      text-align: center;
    }
    
    .auth-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }
    
    .auth-logo i {
      font-size: 2rem;
      color: var(--success);
    }
    
    .auth-logo span {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--success);
    }

    .verify-heading {
      font-size: 1.75rem;
      color: var(--success);
      margin-bottom: var(--spacing-md);
    }

    .verify-text {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-lg);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .verification-code {
      display: flex;
      gap: var(--spacing-sm);
      justify-content: center;
      margin-bottom: var(--spacing-lg);
    }

    .verification-code input {
      width: 3rem;
      height: 3rem;
      text-align: center;
      font-size: 1.5rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      background: #fff;
    }

    .verification-code input:focus {
      border-color: var(--success);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.1);
      outline: none;
    }

    .error-message {
      display: none;
      color: #dc2626;
      background: #fee2e2;
      border: 1px solid #fecaca;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
      font-size: 0.875rem;
    }

    .success-message {
      display: none;
      color: #059669;
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
      font-size: 0.875rem;
    }

    .verify-btn {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--success);
      color: #fff;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .verify-btn:hover {
      background: #16a34a;
    }

    .verify-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .resend-link {
      display: inline-block;
      margin-top: var(--spacing-md);
      color: var(--success);
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .resend-link:hover {
      text-decoration: underline;
    }

    .resend-link.disabled {
      color: #9ca3af;
      cursor: not-allowed;
      pointer-events: none;
    }

    .countdown {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <main class="auth-page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-logo">
          <i class="fas fa-owl"></i>
          <span>Owluminate</span>
        </div>
        
        <h1 class="verify-heading">Verify Your Email</h1>
        <p class="verify-text">We've sent a verification code to your email address. Please enter the code below to verify your account.</p>
        
        <div class="verification-code">
          <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" aria-label="First digit" title="Enter first digit">
          <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" aria-label="Second digit" title="Enter second digit">
          <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" aria-label="Third digit" title="Enter third digit">
          <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" aria-label="Fourth digit" title="Enter fourth digit">
          <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" aria-label="Fifth digit" title="Enter fifth digit">
          <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" aria-label="Sixth digit" title="Enter sixth digit">
        </div>

        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>
        
        <button id="verify-btn" class="verify-btn">Verify Email</button>
        
        <a href="#" id="resend-link" class="resend-link">Resend Code</a>
        <div id="countdown" class="countdown"></div>
      </div>
    </div>
  </main>

  <script>
    // Get all verification code inputs
    const inputs = document.querySelectorAll('.verification-code input');
    const verifyButton = document.getElementById('verify-btn');
    const resendLink = document.getElementById('resend-link');
    const countdownDiv = document.getElementById('countdown');
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');

    let countdownTimer;
    let remainingTime = 0;

    // Auto-focus and input handling
    inputs.forEach((input, index) => {
      // Auto-focus next input
      input.addEventListener('input', (e) => {
        if (e.target.value) {
          if (index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
        }
      });

      // Handle backspace
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          inputs[index - 1].focus();
        }
      });
    });

    // Get verification code from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const storedCode = urlParams.get('code');

    // Function to start countdown timer
    function startCountdown(duration) {
      remainingTime = duration;
      resendLink.classList.add('disabled');
      
      countdownTimer = setInterval(() => {
        remainingTime--;
        countdownDiv.textContent = `Resend code in ${remainingTime} seconds`;
        
        if (remainingTime <= 0) {
          clearInterval(countdownTimer);
          resendLink.classList.remove('disabled');
          countdownDiv.textContent = '';
        }
      }, 1000);
    }

    // Function to verify code
    async function verifyCode() {
      const enteredCode = Array.from(inputs).map(input => input.value).join('');
      
      if (enteredCode.length !== 6) {
        errorDiv.textContent = 'Please enter all 6 digits';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const verifyEmailFunction = firebase.functions().httpsCallable('verifyEmail');
        const result = await verifyEmailFunction({
          userId: auth.currentUser.uid,
          code: enteredCode
        });

        if (result.data.success) {
          successDiv.textContent = 'Email verified successfully! Redirecting to login...';
          successDiv.style.display = 'block';
          errorDiv.style.display = 'none';

          setTimeout(() => {
            window.location.href = 'login-new.html';
          }, 2000);
        }
      } catch (error) {
        let errorMessage = 'Error verifying email. Please try again.';
        
        // Handle specific error cases
        switch (error.code) {
          case 'deadline-exceeded':
            errorMessage = 'Verification code has expired. Please request a new code.';
            break;
          case 'resource-exhausted':
          case 'permission-denied':
            errorMessage = error.message;
            resendLink.classList.add('disabled');
            break;
          case 'invalid-argument':
            errorMessage = 'Invalid verification code. Please try again.';
            break;
          default:
            console.error('Verification error:', error);
        }

        errorDiv.textContent = errorMessage;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
      }
    }

    // Function to resend verification code
    async function resendVerificationCode() {
      try {
        // Generate new code and send email
        const newCode = Math.floor(100000 + Math.random() * 900000).toString();
        // Here you would typically send the new code via email
        // For demo purposes, we'll just update the URL
        window.history.replaceState({}, '', `verify-email.html?email=${email}&code=${newCode}`);
        
        successDiv.textContent = 'New verification code sent!';
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        
        startCountdown(60); // Start 60-second countdown
      } catch (error) {
        errorDiv.textContent = 'Error sending verification code. Please try again.';
        errorDiv.style.display = 'block';
      }
    }

    // Add event listeners
    verifyButton.addEventListener('click', verifyCode);
    resendLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (!resendLink.classList.contains('disabled')) {
        resendVerificationCode();
      }
    });

    // Start initial countdown
    startCountdown(60);
  </script>
</body>
</html>

