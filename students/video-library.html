<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Video Library â€” Prep100</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../general/modernized.css">
    
    <!-- Preload user data -->
    <script>
        // Helper function to get user initials
        function getInitials(fullName) {
            return fullName.split(' ')
                .slice(0, 2)
                .map(name => name.charAt(0))
                .join('')
                .toUpperCase();
        }

        // Initialize user data from cache immediately
        try {
            const cachedUserData = localStorage.getItem('cachedUserData_current');
            if (cachedUserData) {
                const { data } = JSON.parse(cachedUserData);
                window.preloadedUserData = data;
                
                // Pre-initialize user interface as soon as DOM is ready
                document.addEventListener('DOMContentLoaded', () => {
                    if (window.preloadedUserData) {
                        const user = window.preloadedUserData;
                        const fullName = user.displayName || 'Student';
                        const name = fullName.split(' ')[0];
                        const level = (user.profile?.level || '').startsWith('SS') ? user.profile.level : 'SS 3';
                        
                        // Update UI elements immediately
                        const elements = {
                            topName: fullName,
                            userName: fullName,
                            topLevel: level
                        };
                        
                        // Update text content
                        Object.keys(elements).forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.textContent = elements[id];
                        });
                        
                        // Update video library title
                        const hero = document.querySelector('h1');
                        if (hero) hero.textContent = `${name}'s Video Library`;
                        
                        // Update avatars
                        const initials = getInitials(fullName);
                        const avatarUrl = user.photoURL || 
                            `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=2563eb&color=fff&size=128`;
                        
                        ['avatar-sm', 'topAvatar'].forEach(id => {
                            const img = document.getElementById(id);
                            if (img) img.src = avatarUrl;
                        });
                        
                        // Store user context for video preferences
                        window.videoUserContext = {
                            name: fullName,
                            shortName: name,
                            level: level,
                            avatarUrl: avatarUrl,
                            preferences: user.profile?.videoPreferences || {}
                        };
                    }
                });
            }
        } catch (e) {
            console.warn('Error preloading user data:', e);
        }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div class="min-h-screen flex">
      <!-- Sidebar -->
  <aside id="sidebar" class="w-64 md:w-72 lg:w-80 fixed left-0 top-0 h-full bg-white border-r border-slate-200 p-5 flex flex-col gap-6 transition-transform duration-300 ease-in-out overflow-auto z-40 -translate-x-full lg:translate-x-0">
        <div class="flex items-center gap-3">
          <img src="/assets/images/logo.png" alt="logo" class="h-12 w-12 rounded-full shadow-sm">
          <div>
            <div class="text-lg font-bold text-sky-700">JUANOVA CORTEX</div>
            <div class="text-xs text-slate-500">Student Dashboard</div>
          </div>
        </div>

        <nav class="flex-1 overflow-auto">
          <ul class="space-y-1">
            <li><a href="student-dashboard.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-home text-sky-600"></i> Home</a></li>
            <li><a href="news-feed-gemini.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-newspaper text-pink-500"></i> News Feed</a></li>
            <li><a href="ai-tutor-chatbot.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-robot text-purple-500"></i> AI Tutor</a></li>
            <li><a href="study-plan.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-calendar-check text-green-500"></i> Study Plan</a></li>
           <li><a href="all-formula.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-book-open text-teal-600"></i> All Formula</a></li>
            <li><a href="video-library.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-video text-red-500"></i> Video Library</a></li>
            <li><a href="mock-exams.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-pencil-alt text-orange-500"></i> Mock Exams</a></li>
            <li><a href="notifications.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-bell text-pink-600"></i> Notifications</a></li>
            <li><a href="student-live-session.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-chalkboard-teacher text-blue-400"></i> Live Sessions</a></li>
            <li><a href="smart-note.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-sticky-note text-yellow-500"></i> Smart Notes</a></li>
          </ul>
        </nav>

        <div class="text-sm text-slate-500">
          <div class="mb-2">Account</div>
          <div class="flex items-center gap-3">
            <img id="avatar-sm" src="../assets/images/unnamed.jpg" alt="avatar" class="h-10 w-10 rounded-full border">
              <div>
                <div id="userName" class="font-semibold">Student</div>
              </div>
          </div>
        </div>
      </aside>
  <div id="main-content" class="flex-1 flex flex-col lg:ml-72">
        <header class="flex items-center justify-between p-4 bg-white border-b border-slate-200">
          <div class="flex items-center gap-3">
            <button id="toggleSidebar" class="p-2 rounded-md hover:bg-slate-100 lg:hidden" title="Toggle sidebar"><i class="fas fa-bars"></i></button>
            <div class="relative">
              <input id="globalSearch" type="search" placeholder="Search for videos..." class="w-full max-w-[520px] pl-4 pr-4 py-2 rounded-full border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-sky-100">
            </div>
          </div>

          <div class="flex items-center gap-4">
            <div class="relative">
              <button id="notifBtn" class="p-2 rounded-full hover:bg-slate-50" aria-label="Notifications"><i class="fas fa-bell text-sky-600"></i></button>
              <span id="notifCount" class="absolute -top-1 -right-1 bg-pink-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right mr-2">
                <div id="topName" class="font-semibold">Student Name</div>
                <div id="topLevel" class="text-xs text-slate-400">SS 3</div>
              </div>
              <img id="topAvatar" src="../assets/images/unnamed.jpg" alt="avatar" class="h-10 w-10 rounded-full border-2">
            </div>
          </div>
        </header>

        <main class="p-6 space-y-6">
          <!-- main page controls moved into canonical header to avoid duplicate topbars -->
          <div class="mb-6">
            <!-- page-specific controls (kept minimal) -->
            <div class="flex items-center justify-between">
              <div></div>
            </div>
          </div>

          <div class="rounded-3xl bg-gradient-to-r from-indigo-600 to-indigo-400 text-white p-6 shadow mb-6">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-extrabold">Video Library</h1>
                <p class="text-indigo-100 mt-1">Curated videos to support your lessons and revision.</p>
              </div>
            </div>
          </div>

          <div class="filters mb-4 flex flex-wrap gap-2">
            <button class="px-3 py-1 rounded-full bg-blue-600 text-white">All Subjects</button>
            <button class="px-3 py-1 rounded-full bg-white border">Mathematics</button>
            <button class="px-3 py-1 rounded-full bg-white border">Physics</button>
            <button class="px-3 py-1 rounded-full bg-white border">Chemistry</button>
          </div>

          <div class="video-grid space-y-6">
            <div class="video-wrapper relative w-full" style="padding-top:56.25%;">
              <iframe class="absolute inset-0 w-full h-full" width="560" height="315" src="https://www.youtube-nocookie.com/embed/videoseries?si=WemiSyBGUgXINVFx&amp;list=PLSP1xX8sdp-A51bLjSESoO4_a5mVo3QYl" title="YouTube playlist" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
            <div class="text-sm text-slate-500">Tip: Use the search above to filter by subject.</div>
          </div>
        </main>
      </div>
    </div>

    <script type="module">
      // Personalize video library with background updates only when needed
      import('./js/firebase-user-helper.js').then(({ initUserPersonalization }) => {
        // Skip immediate updates if we have preloaded data
        initUserPersonalization(async ({ user, helpers }) => {
          if (!user) return;
          
          const currentName = document.getElementById('userName')?.textContent;
          const fullName = user.displayName || 'Student';
          
          // Only update if data is different from what's displayed
          if (currentName !== fullName) {
            const name = fullName.split(' ')[0];
            const level = (user.profile?.level || '').startsWith('SS') ? user.profile.level : 'SS 3';
            
            // Update text elements
            const elements = {
              topName: fullName,
              userName: fullName,
              topLevel: level
            };
            
            Object.keys(elements).forEach(id => {
              const el = document.getElementById(id);
              if (el) el.setAttribute('textContent', elements[id]);
            });
            
            // Update video library title
            const hero = document.querySelector('h1');
            if (hero) hero.textContent = `${name}'s Video Library`;
            
            // Update avatars
            const initials = getInitials(fullName);
            const avatarUrl = user.photoURL || 
              `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=2563eb&color=fff&size=128`;
            
            ['avatar-sm', 'topAvatar'].forEach(id => {
              const img = document.getElementById(id);
              if (img) img.src = avatarUrl;
            });
            
            // Update video preferences
            window.videoUserContext = {
              name: fullName,
              shortName: name,
              level: level,
              avatarUrl: avatarUrl,
              preferences: user.profile?.videoPreferences || {}
            };
            
            // Cache the fresh data
            try {
              localStorage.setItem('cachedUserData_current', JSON.stringify({
                data: user,
                timestamp: Date.now()
              }));
            } catch (e) {
              console.warn('Failed to cache user data:', e);
            }
          }
          
          // Always update notification count as it's dynamic
          const notifEl = document.getElementById('notifCount');
          if (notifEl && helpers?.getUnreadNotificationsCount) {
            notifEl.textContent = String(await helpers.getUnreadNotificationsCount(user.uid));
          }
        });
      }).catch(e => console.warn('firebase-user helper import failed', e));
    </script>

    <link rel="stylesheet" href="./dashboard-styles.css">
    <script>
      (function ensureSidebarToggle(){ try{ const b=document.getElementById('toggleSidebar'); if(b && !b.dataset.hasToggle){ b.addEventListener('click', (e)=> {
        e.stopPropagation();
        document.getElementById('sidebar').classList.toggle('-translate-x-full')
      }); b.dataset.hasToggle='1'; } }catch(e){} })();
      document.getElementById('main-content').addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.add('-translate-x-full');
        }
      });
    </script>
  </body>
</html>
