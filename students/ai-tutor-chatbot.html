<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Tutor - EduNext</title>
  <link rel="stylesheet" href="../general/modernized.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Dashboard Specific Styles */
    .dashboard-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-sm) 0;
    }
    
    .search-container {
      flex: 1;
      max-width: 480px;
      position: relative;
      margin-right: var(--spacing-xl);
    }
    
    .search-icon {
      position: absolute;
      left: var(--spacing-sm);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 1.1rem;
    }
    
    .search-input {
      width: 100%;
      padding: 0.875rem var(--spacing-xl);
      padding-left: 2.75rem;
      border-radius: 9999px;
      border: 2px solid var(--border-color);
      font-size: 1rem;
      transition: all 0.2s;
      background: #fff;
    }
    
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
      outline: none;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    .notification-btn {
      position: relative;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
      padding: var(--spacing-xs);
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }
    
    .notification-btn:hover {
      color: var(--primary);
      background: rgba(37,99,235,0.1);
    }
    
    .notification-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .welcome-banner {
      background: var(--primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      color: white;
      margin-bottom: var(--spacing-xl);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(37,99,235,0.15);
    }

    .welcome-banner h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: var(--spacing-sm);
    }

    .welcome-banner p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: var(--spacing-md);
    }

    .welcome-banner .btn-continue {
      background: white;
      color: var(--primary);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--radius-full);
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .welcome-banner .btn-continue:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .stat-card {
      background: var(--surface-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      text-align: center;
      transition: all 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-title {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: var(--spacing-xs);
    }

    .stat-value {
      color: var(--text-primary);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: var(--spacing-xs);
    }

    .stat-subtitle {
      color: var(--text-tertiary);
      font-size: 0.85rem;
    }
    .chat-container {
      background: var(--surface-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      padding: var(--spacing-xl);
      margin: 0 auto var(--spacing-xl) auto;
      transition: all 0.2s;
    }

    .chat-container:hover {
      box-shadow: var(--shadow-md);
    }

    .chat-messages {
      min-height: 300px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: var(--spacing-lg);
      padding-right: var(--spacing-sm);
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: var(--surface-hover);
      border-radius: var(--radius-full);
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: var(--radius-full);
    }

    .message {
      margin-bottom: var(--spacing-md);
      opacity: 0;
      transform: translateY(10px);
      animation: messageAppear 0.3s ease forwards;
    }
    .input-area {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 1rem;
    }
    .input-area input {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #cbd5e1;
      border-radius: 24px;
      outline: none;
      font-size: 1rem;
    }
    .input-area button {
      padding: 10px 20px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .input-area button:hover {
      background: #1e3a8a;
    }
    .mic-button {
      padding: 10px;
      background: #4b5e97;
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin-left: 8px;
    }
    .suggestions {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      flex-wrap: wrap;
      background: var(--surface-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: var(--spacing-lg);
      justify-content: center;
    }

    .suggestion-chip {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--primary-light);
      border: none;
      border-radius: var(--radius-full);
      font-size: 1rem;
      color: var(--primary-dark);
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(37,99,235,0.07);
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }

    .suggestion-chip:hover {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 16px rgba(37,99,235,0.13);
      transform: translateY(-2px);
    }
    @media (max-width: 700px) {
      .sidebar { width: 100px; }
      .main-content { margin-left: 100px; padding: 16px; }
      .chat-container { max-height: 300px; }
      .input-area input { width: 70%; }
    }
  </style>
  <div class="app-container">
    <aside class="sidebar">
      <a href="#" class="sidebar__logo">
        <i class="fas fa-graduation-cap"></i>
        <span>EduNext-prep100</span>
      </a>
      <nav class="sidebar__menu">
        <a href="student-dashboard.html" class="sidebar__item">
          <i class="fas fa-home"></i> Home
        </a>
        <a href="ai-tutor-chatbot.html" class="sidebar__item active">
          <i class="fas fa-robot"></i> AI Tutor
        </a>
        <a href="study-plan.html" class="sidebar__item">
          <i class="fas fa-calendar-alt"></i> Study Plan
        </a>
        <a href="smart-note.html" class="sidebar__item">
          <i class="fas fa-sticky-note"></i> Smart Notes
        </a>
        <a href="video-library.html" class="sidebar__item">
          <i class="fas fa-video"></i> Video Library
        </a>
        <a href="mock-exams.html" class="sidebar__item">
          <i class="fas fa-file-alt"></i> Mock Exams
        </a>
        <a href="practice-exams.html" class="sidebar__item">
          <i class="fas fa-pencil-alt"></i> Practice Exams
        </a>
        <a href="notifications.html" class="sidebar__item">
          <i class="fas fa-bell"></i> Notifications
        </a>
        <a href="student-live-session.html" class="sidebar__item">
          <i class="fas fa-chalkboard-teacher"></i> Join Live Session
        </a>
      </nav>
    </aside>
    <main class="main-content">
      <div class="dashboard-topbar">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" placeholder="Search topics, lessons, or ask a question...">
        </div>
        <div class="user-info">
          <div class="badge badge-primary">SS 3/WAEC</div>
          <button class="notification-btn">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">2</span>
          </button>
          <img src="" alt="User avatar" class="avatar">
        </div>
      </div>

      <div class="welcome-banner">
        <div class="banner-content">
          <h1>Ready to Learn?</h1>
          <p>Your personalized learning journey continues. Let's make every question count!</p>
          <button class="btn-continue">Start Learning</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">Questions Asked</div>
          <div class="stat-value">24</div>
          <div class="stat-subtitle">This Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Understanding Score</div>
          <div class="stat-value">78%</div>
          <div class="stat-subtitle">Based on Responses</div>
        </div>
      </div>

      <div class="suggestions">
        <button class="suggestion-chip">How do I solve quadratic equations?</button>
        <button class="suggestion-chip">Explain photosynthesis</button>
        <button class="suggestion-chip">Help with Newton's laws</button>
        <button class="suggestion-chip">Literary devices in poetry</button>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <!-- AI welcome message -->
          <div class="message ai">
            <img src="https://ui-avatars.com/api/?name=AI&background=2563eb&color=fff" alt="AI" class="message-avatar">
            <div class="message-content">
              <p>Hello! I'm your AI tutor. I'm here to help you with your studies. What would you like to learn about today?</p>
            </div>
          </div>
        </div>

        <div class="input-area">
          <input type="text" id="userInput" class="chat-input" placeholder="Type your question here..." onkeypress="if(event.key === 'Enter') askAI()">
          <button class="mic-button" id="micButton" onclick="startVoiceInput()" title="Start voice input" aria-label="Start voice input">
            <i class="fas fa-microphone"></i>
          </button>
          <button class="send-button" onclick="askAI()" title="Send message" aria-label="Send message">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </main>
  </div>
  <script>
    let chatHistory = [];
    let recognition;

    // Initialize user info
    function initUserInfo() {
      const session = JSON.parse(sessionStorage.getItem('eduNextSession') || '{"name":"Student"}');
      document.querySelector('.avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(session.name)}&background=2563eb&color=fff`;
    }
    initUserInfo();

    function addMessage(content, isUser = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
      
      const avatar = document.createElement('img');
      avatar.className = 'message-avatar';
      avatar.src = isUser ? 
        document.querySelector('.avatar').src :
        'https://ui-avatars.com/api/?name=AI&background=2563eb&color=fff';
      avatar.alt = isUser ? 'User' : 'AI';

      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = content;

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window)) {
        addMessage('Voice input requires a supported browser like Chrome. Please use text or switch browsers.');
        return;
      }
      try {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.onresult = (event) => {
          const query = event.results[0][0].transcript.trim();
          addMessage(query, true);
          askAI(query);
        };
        recognition.onerror = (event) => {
          addMessage(`Voice input failed: ${event.error}. Please try again or use text.`);
        };
        recognition.start();
      } catch (error) {
        addMessage('An error occurred with voice input. Please use text input instead.');
      }
    }

    async function fetchWebSummary(query) {
      const simulatedSources = [
        `Source 1: Information on ${query} suggests...`,
        `Source 2: Recent data indicates...`,
        `Source 3: Another perspective highlights...`
      ];
      return `Summary based on available information: ${query}. Key points from various sources: ${simulatedSources.join(' ')}.`;
    }

    // Add click handlers for suggestion chips
    document.querySelectorAll('.suggestion-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.getElementById('userInput').value = chip.textContent;
        askAI();
      });
    });

    async function askAI(query = null) {
      const input = document.getElementById('userInput');
      if (!query) query = input.value.trim();
      if (!query) return;
      if (!input.value) addMessage(query, true); // For voice input
      input.value = '';

      try {
        let prompt = `Provide a clear and concise answer to "${query}".`;
        if (chatHistory.length > 0 && chatHistory.some(prev => prev.query.toLowerCase().includes(query.toLowerCase()))) {
          prompt += ' Refer to prior discussions for context and add new details.';
        }
        if (query.toLowerCase().match(/richest|president|capital/i)) {
          prompt += ' Keep it factual and summarized, using the latest available data.';
        } else if (query.toLowerCase().includes('physics') || query.toLowerCase().includes('chemistry') || query.toLowerCase().includes('biology') || query.toLowerCase().includes('waec') || query.toLowerCase().includes('neco') || query.toLowerCase().includes('jamb')) {
          prompt += ' Explain like a teacher with step-by-step breakdown and a simple example, tailored for exam prep.';
        } else {
          prompt += ' Include a brief example if it clarifies the answer.';
        }

        const response = await fetch('/.netlify/functions/gemini', {
          method: 'POST',
          body: JSON.stringify({ prompt }),
        });
        
        const data = await response.json();
        let explanation = data.candidates[0]?.content.parts[0].text || 'I couldn’t find a direct answer. Let me search for more information.';
        if (explanation.includes('couldn’t fetch') || explanation.includes('try again')) {
          const webSummary = await fetchWebSummary(query);
          explanation = webSummary;
        }
        addMessage(explanation);
        chatHistory.push({ query, explanation });
      } catch (error) {
        console.error('Error:', error);
        addMessage('Sorry, there was an issue processing your request. Please try again later.');
      }
    }
  </script>
</body>
</html>