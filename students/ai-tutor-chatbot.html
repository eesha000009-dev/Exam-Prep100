<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/images/Logo of JUANOVA Cortex Tutor.png" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI Tutor — JUANOVA CORTEX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}</style>

    <!-- Responsive overrides -->
    <style>
      /* Ensure main keeps same left offset as the dashboard (ml-72 == 18rem) */
      main { margin-left: 18rem; transition: margin 200ms ease; }

      /* Chat section sizing by id */
      #chatSection { height: 72vh; min-height: 520px; }

      /* Tablet: hide sidebar and use full width (but allow JS toggle by targeting .hide-on-mobile) */
      @media (max-width: 1024px) {
        aside.hide-on-mobile { display: none !important; }
        main { margin-left: 0 !important; padding-left: 1rem !important; padding-right: 1rem !important; }
        #chatSection { height: 66vh; min-height: 420px; }
      }

      /* Mobile: tighter layout, stack banner, increase touch targets */
      @media (max-width: 640px) {
        #chatSection { height: 60vh; min-height: 360px; }
        .rounded-3xl { padding: 1rem; }
        .suggestion-chip { padding: 0.5rem 0.75rem; font-size: 0.92rem; }
        textarea#userInput { min-height: 56px; }
        .max-w-4xl { padding-left: 0.5rem; padding-right: 0.5rem; }
        /* Make sure bubbles don't exceed full width */
        #chatMessages > div > div { max-width: 100% !important; }
      }
    </style>
  </head>
  <body class="bg-gray-50">

    <div class="flex min-h-screen">
      <!-- Sidebar (same visual style as student dashboard) -->
        <aside class="fixed top-0 left-0 h-screen bg-white/80 backdrop-blur-lg shadow-xl w-72 flex flex-col px-4 py-6 border-r border-gray-200 overflow-y-auto z-50">
            <div class="sticky top-0 bg-white/95 backdrop-blur-lg z-10 py-2 mb-8">
                <a href="#" class="flex items-center gap-3">
                    <img src="/assets/images/Logo%20of%20JUANOVA%20Cortex%20Tutor.png" alt="Logo" class="h-16 w-16 object-contain rounded-full shadow-2xl border-4 border-blue-700">
                    <span class="text-3xl font-extrabold text-blue-800 tracking-tight font-serif italic drop-shadow-lg">JUANOVA CORTEX</span>
                </a>
            </div>
            
            <nav class="flex flex-col gap-2 text-gray-700 font-medium">
                <a href="student-dashboard.html" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-blue-50 text-blue-600">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="news-feed-gemini.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-newspaper text-pink-500"></i> News Feed
                </a>
                <a href="ai-tutor-chatbot.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-robot text-purple-500"></i> AI Tutor
                </a>
                <a href="all-formula.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-book-open text-teal-600"></i> All Formula
                </a>
                <a href="smart-note.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-sticky-note text-yellow-500"></i> Smart Notes
                </a>
                <a href="study-plan.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-calendar-alt text-green-500"></i> Study Plan
                </a>
                <a href="video-library.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-video text-red-500"></i> Video Library
                </a>
                <a href="practice-exams.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-pencil-alt text-orange-500"></i> Mock Exams
                </a>
                <a href="notifications.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-bell text-pink-600"></i> Notifications
                </a>
                <a href="student-live-session.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-chalkboard-teacher text-blue-400"></i> Join Live Session
                </a>
            </nav>
        </aside>

      <!-- Main content -->
      <main class="flex-1 p-8 ml-72">
        <!-- Mobile: Hamburger to toggle sidebar -->
        <button id="openSidebarBtn" aria-label="Open menu" class="lg:hidden absolute top-6 left-4 p-2 bg-white rounded-md shadow-md hidden">
          <i class="fas fa-bars text-gray-700"></i>
        </button>
        <!-- Overlay when sidebar open on mobile -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>
        <!-- Top Bar -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex-1 max-w-xl relative">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input aria-label="Search topics" class="w-full pl-12 pr-4 py-3 rounded-full border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 bg-white" placeholder="Search topics, lessons, or ask a question...">
          </div>
          <div class="flex items-center gap-4">
            <span id="student-level" class="bg-blue-100 text-blue-700 px-4 py-1 rounded-full font-semibold text-sm">SS 3 / WAEC</span>
            <span id="student-name" class="font-semibold text-gray-700">Student</span>
            <button title="Notifications" class="p-2 rounded-full hover:bg-blue-100 transition"><i class="fas fa-bell text-blue-600"></i></button>
            <img id="userAvatar" src="/assets/images/unnamed.jpg" alt="User" class="h-10 w-10 rounded-full border-2 border-blue-500">
          </div>
        </div>

        <!-- Banner -->
        <div class="rounded-3xl bg-gradient-to-r from-blue-600 to-blue-400 text-white p-6 shadow-xl mb-6 max-w-4xl">
          <div class="flex items-center gap-6">
            <div class="flex-shrink-0">
              <i class="fas fa-robot text-6xl"></i>
            </div>
            <div>
              <h1 class="text-2xl md:text-3xl font-extrabold">AI Tutor — Instant help & explanations</h1>
              <p class="text-blue-100 mt-1">Ask questions, get step-by-step solutions and exam tips tailored to your needs.</p>
            </div>
          </div>
        </div>

        <!-- Helper chips -->
        <div class="flex flex-wrap gap-3 mb-6">
          <button class="px-4 py-2 bg-white rounded-full shadow text-blue-600 font-semibold suggestion-chip">How to solve quadratic equations?</button>
          <button class="px-4 py-2 bg-white rounded-full shadow text-blue-600 font-semibold suggestion-chip">Explain photosynthesis</button>
          <button class="px-4 py-2 bg-white rounded-full shadow text-blue-600 font-semibold suggestion-chip">Newton's laws — simple</button>
          <button id="clearBtn" class="px-4 py-2 bg-white rounded-full border border-gray-200 text-gray-700">Clear chat</button>
        </div>

  <!-- Chat area -->
  <section id="chatSection" class="bg-white rounded-2xl shadow p-6 max-w-4xl mx-auto h-[72vh] min-h-[520px] flex flex-col">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <i class="fas fa-robot text-2xl text-purple-600"></i>
              <div>
                <div class="font-semibold">AI Tutor</div>
                <div id="status" class="text-sm text-gray-500">Ready</div>
              </div>
            </div>
            <div class="text-sm text-gray-500">Instant help</div>
          </div>

          <div id="chatMessages" class="flex-1 overflow-auto space-y-4 mb-4" aria-live="polite"></div>
          <div id="typingIndicator" class="text-sm text-gray-500 mb-2 hidden">AI is typing…</div>

          <div class="flex gap-3 items-center border-t pt-3">
            <textarea id="userInput" class="flex-1 resize-none min-h-[44px] max-h-[140px] p-3 rounded-lg border border-gray-200" placeholder="Type a question (Shift+Enter for newline, Ctrl+Enter or Enter to send)"></textarea>
            <button id="micButton" title="Start voice input" class="p-3 rounded-lg border border-gray-200 hover:bg-gray-50"><i class="fas fa-microphone"></i></button>
            <button id="sendBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg disabled:opacity-50" aria-label="Send message" disabled><i class="fas fa-paper-plane"></i></button>
          </div>
        </section>
  </main>
    </div>

    <script>
        // Sidebar toggle and active link logic
        (function(){
          const sidebar = document.getElementById('mainSidebar');
          const openBtn = document.getElementById('openSidebarBtn');
          const overlay = document.getElementById('sidebarOverlay');

          function openSidebar(){ sidebar.style.display='flex'; overlay.classList.remove('hidden'); openBtn.classList.add('hidden'); document.body.style.overflow='hidden'; }
          function closeSidebar(){ sidebar.style.display='none'; overlay.classList.add('hidden'); openBtn.classList.remove('hidden'); document.body.style.overflow='auto'; }

          // Show hamburger only on small screens
          function updateHamburger(){ if(window.innerWidth<=1024){ openBtn.classList.remove('hidden'); } else { openBtn.classList.add('hidden'); sidebar.style.display='flex'; overlay.classList.add('hidden'); document.body.style.overflow='auto'; }}
          updateHamburger(); window.addEventListener('resize', updateHamburger);

          openBtn.addEventListener('click', openSidebar);
          overlay.addEventListener('click', closeSidebar);

          // Escape to close
          document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSidebar(); });

          // Auto-mark active nav item based on pathname
          const navLinks = document.querySelectorAll('aside a');
          const current = location.pathname.split('/').pop() || 'student-dashboard.html';
          navLinks.forEach(a=>{
            const href = a.getAttribute('href')||'';
            if(href === current || (href !== '#' && current.startsWith(href.replace('./','')))){
              a.classList.add('bg-blue-50','text-blue-600');
            } else {
              a.classList.remove('bg-blue-50','text-blue-600');
            }
          });
        })();
      // preserve original chat logic, adapted to the new DOM
      const chatMessages = document.getElementById('chatMessages');
      const userInput = document.getElementById('userInput');
      const sendBtn = document.getElementById('sendBtn');
      const typingIndicator = document.getElementById('typingIndicator');
      const clearBtn = document.getElementById('clearBtn');
      let chatHistory = [];

      function initUserInfo(){
        const session = JSON.parse(sessionStorage.getItem('eduNextSession')||'{"name":"Student"}');
        const avatar = document.getElementById('userAvatar');
        if(avatar) avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(session.name)}&background=2563eb&color=fff`;
        const nameEl = document.getElementById('student-name'); if(nameEl) nameEl.textContent = session.name || 'Student';
      }
      initUserInfo();

      function timeStamp(){ return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

      function addMessage(text, isUser=false){
        const wrapper = document.createElement('div');
        wrapper.className = isUser ? 'flex justify-end' : 'flex justify-start';
        const bubble = document.createElement('div');
        bubble.className = (isUser ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800') + ' p-3 rounded-lg shadow max-w-[80%]';
        bubble.innerHTML = `<div>${escapeHtml(text)}</div><div class="text-xs text-gray-400 mt-1">${timeStamp()}</div>`;
        wrapper.appendChild(bubble);
        chatMessages.appendChild(wrapper);
        wrapper.scrollIntoView({behavior:'smooth', block:'end'});
      }

      function escapeHtml(unsafe){ return unsafe.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

      function setTyping(on){ typingIndicator.style.display = on ? 'block' : 'none'; document.getElementById('status').textContent = on ? 'Thinking...' : 'Ready'; }

      document.querySelectorAll('.suggestion-chip').forEach(el => el.addEventListener('click', ()=>{ userInput.value = el.textContent; sendBtn.disabled = false; userInput.focus(); }));
      clearBtn.addEventListener('click', ()=>{ chatMessages.innerHTML=''; chatHistory=[]; addWelcome(); });
      userInput.addEventListener('input', ()=> sendBtn.disabled = userInput.value.trim().length===0);
      userInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && e.ctrlKey){ e.preventDefault(); handleSend(); } else if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey){ e.preventDefault(); handleSend(); }});
      sendBtn.addEventListener('click', handleSend);

      function addWelcome(){ addMessage("Hello! I'm your AI tutor. Ask anything to get started.", false); }
      addWelcome();

      async function handleSend(){
        const q = userInput.value.trim();
        if (!q) return;
        userInput.value=''; sendBtn.disabled=true; addMessage(q, true); setTyping(true);
        try{
          const prompt = `You are an expert tutor. Answer clearly and with examples: ${q}`;
          // Use the Express backend route. When developing locally run the Node server
          // and open the server origin (e.g. http://localhost:3000) so this relative
          // path hits the API. Using VS Code Live Server (static-only) will not
          // forward this POST and can produce 405 responses.
          const fetchUrl = '/api/cortex-ai/chat';
          const res = await fetch(fetchUrl,{
            method:'POST',
            headers: {'Content-Type':'application/json'},
            // routes/api.js expects { message, subject, context }
            body: JSON.stringify({ message: q })
          });

          if (!res.ok) {
            // Try to surface useful server response (HTML or text) when status is not OK
            const text = await res.text().catch(()=>'<no response body>');
            throw new Error(`Server returned ${res.status}: ${text}`);
          }

          let data;
          const ct = (res.headers.get('content-type') || '').toLowerCase();
          if (ct.includes('application/json')) {
            try {
              data = await res.json();
            } catch (e) {
              throw new Error('Response JSON parsing failed');
            }
          } else {
            // Non-JSON success response (fallback to plain text)
            const text = await res.text().catch(()=>'');
            data = { text };
          }

          // Server returns { response: <geminiData> } (or { text })
          let explanation = '';
          if (data?.text && typeof data.text === 'string') {
            explanation = data.text;
          } else if (data?.response) {
            const resp = data.response;
            if (typeof resp === 'string') {
              explanation = resp;
            } else if (typeof resp === 'object') {
              // Try common Gemini-like shapes safely
              explanation = (resp?.candidates && resp.candidates[0] && resp.candidates[0].content)
                ? resp.candidates[0].content.map(p => p.text || '').join('')
                : (resp?.output && Array.isArray(resp.output))
                  ? resp.output.map(o => (o.content||[]).map(c=>c.text||'').join('')).join('\n')
                  : JSON.stringify(resp).slice(0,1000);
            }
          }
          if (!explanation) explanation = 'Sorry, I could not get an answer right now.';
          setTyping(false);
          addMessage(explanation, false);
          chatHistory.push({q, explanation});

          // If server returned base64 audio (data:...;base64,...), play it
          if (data?.audio) {
            try {
              const a = new Audio(data.audio);
              a.play().catch(e => { console.warn('Audio play failed', e); });
            } catch (e) { console.warn('Audio playback error', e); }
          }
        } catch(err) {
          console.error('AI request failed:', err);
          setTyping(false);
          // Show a clear error message to help debugging (status, body, or parse error)
          addMessage(`Error: ${err.message}`, false);
        }
      }

      const obs = new MutationObserver(()=>{ chatMessages.setAttribute('aria-busy','false'); });
      obs.observe(chatMessages,{childList:true});

      document.getElementById('micButton').addEventListener('click', ()=>{
        if (!('webkitSpeechRecognition' in window)) { addMessage('Voice input needs Chrome or Edge.'); return; }
        try{
          const recognition = new webkitSpeechRecognition(); recognition.continuous=false; recognition.interimResults=false; recognition.lang='en-US';
          recognition.onresult = e=>{ const t = e.results[0][0].transcript.trim(); userInput.value = t; sendBtn.disabled=false; handleSend(); };
          recognition.onerror = e=> addMessage('Voice input error: '+e.error);
          recognition.start();
        }catch(e){ addMessage('Voice input unavailable.'); }
      });
    </script>
  </body>
</html>