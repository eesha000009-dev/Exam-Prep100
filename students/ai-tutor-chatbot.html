<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI Tutor — Prep100</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div class="min-h-screen flex">
      <!-- Sidebar (canonical) -->
  <aside id="sidebar" class="w-72 fixed left-0 top-0 h-full bg-white border-r border-slate-200 p-5 flex flex-col gap-6 transition-transform duration-200 overflow-auto z-40">
        <div class="flex items-center gap-3">
          <img src="/assets/images/logo.png" alt="logo" class="h-12 w-12 rounded-full shadow-sm">
          <div>
            <div class="text-lg font-bold text-sky-700">JUANOVA CORTEX</div>
            <div class="text-xs text-slate-500">Student Dashboard</div>
          </div>
        </div>

        <nav class="flex-1 overflow-auto">
          <ul class="space-y-1">
            <li><a href="student-dashboard.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-home text-sky-600"></i> Home</a></li>
            <li><a href="news-feed-gemini.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-newspaper text-pink-500"></i> News Feed</a></li>
            <li><a href="ai-tutor-chatbot.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-robot text-purple-500"></i> AI Tutor</a></li>
            <li><a href="study-plan.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-calendar-check text-green-500"></i> Study Plan</a></li>
            <li><a href="all-formula.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-book-open text-teal-600"></i> All Formula</a></li>
            <li><a href="video-library.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-video text-red-500"></i> Video Library</a></li>
            <li><a href="mock-exams.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-pencil-alt text-orange-500"></i> Mock Exams</a></li>
            <li><a href="notifications.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-bell text-pink-600"></i> Notifications</a></li>
            <li><a href="student-live-session.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-chalkboard-teacher text-blue-400"></i> Live Sessions</a></li>
            <li><a href="smart-note.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-sticky-note text-yellow-500"></i> Smart Notes</a></li>
          </ul>
        </nav>

        <div class="text-sm text-slate-500">
          <div class="mb-2">Account</div>
          <div class="flex items-center gap-3">
            <img id="avatar-sm" src="../assets/images/unnamed.jpg" alt="avatar" class="h-10 w-10 rounded-full border">
            <div>
              <div id="userName" class="font-semibold">Student</div>
              <div id="userLevel" class="text-xs text-slate-400"></div>
            </div>
          </div>
        </div>
      </aside>

  <div class="flex-1 flex flex-col ml-72">
        <header class="flex items-center justify-between p-4 bg-white border-b border-slate-200">
          <div class="flex items-center gap-3">
            <button id="toggleSidebar" class="p-2 rounded-md hover:bg-slate-100" title="Toggle sidebar"><i class="fas fa-bars"></i></button>
            <div class="relative">
              <input id="globalSearch" type="search" placeholder="Search subjects, topics, resources..." class="w-[520px] hidden md:inline-block pl-10 pr-4 py-2 rounded-full border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-sky-100">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <div class="relative">
              <button id="notifBtn" class="p-2 rounded-full hover:bg-slate-50" aria-label="Notifications"><i class="fas fa-bell text-sky-600"></i></button>
              <span id="notifCount" class="absolute -top-1 -right-1 bg-pink-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right mr-2">
                <div id="topName" class="font-semibold">Student Name</div>
                <div id="topLevel" class="text-xs text-slate-400">SS 3</div>
              </div>
              <img id="topAvatar" src="../assets/images/unnamed.jpg" alt="avatar" class="h-10 w-10 rounded-full border-2">
            </div>
          </div>
        </header>

        <main class="p-6 space-y-6">
          <!-- preserved AI tutor content -->

          <div class="dashboard-topbar">
            <div class="search-container">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" placeholder="Search topics, lessons, or ask a question...">
            </div>
            <div class="user-info">
              <div class="badge badge-primary">SS 3/WAEC</div>
              <button class="notification-btn">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">2</span>
              </button>
              <img src="" alt="User avatar" class="avatar">
            </div>
          </div>

          <div class="welcome-banner">
            <div class="banner-content">
              <h1>Ready to Learn?</h1>
              <p>Your personalized learning journey continues. Let's make every question count!</p>
              <button class="btn-continue">Start Learning</button>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-title">Questions Asked</div>
              <div class="stat-value">24</div>
              <div class="stat-subtitle">This Week</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Understanding Score</div>
              <div class="stat-value">78%</div>
              <div class="stat-subtitle">Based on Responses</div>
            </div>
          </div>

          <div class="suggestions">
            <button class="suggestion-chip">How do I solve quadratic equations?</button>
            <button class="suggestion-chip">Explain photosynthesis</button>
            <button class="suggestion-chip">Help with Newton's laws</button>
            <button class="suggestion-chip">Literary devices in poetry</button>
          </div>

          <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
              <!-- AI welcome message -->
              <div class="message ai">
                <img src="https://ui-avatars.com/api/?name=AI&background=2563eb&color=fff" alt="AI" class="message-avatar">
                <div class="message-content">
                  <p>Hello! I'm your AI tutor. I'm here to help you with your studies. What would you like to learn about today?</p>
                </div>
              </div>
            </div>

            <div class="input-area">
              <input type="text" id="userInput" class="chat-input" placeholder="Type your question here..." onkeypress="if(event.key === 'Enter') askAI()">
              <button class="mic-button" id="micButton" onclick="startVoiceInput()" title="Start voice input" aria-label="Start voice input">
                <i class="fas fa-microphone"></i>
              </button>
              <button class="send-button" onclick="askAI()" title="Send message" aria-label="Send message">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
    <script type="module">
    let chatHistory = [];
    let recognition;

    // Initialize user info from session fallback
    function initUserInfo() {
      const session = JSON.parse(sessionStorage.getItem('eduNextSession') || '{"name":"Student"}');
      const avatarEl = document.querySelector('.avatar');
      if (avatarEl) avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(session.name)}&background=2563eb&color=fff`;
    }
    initUserInfo();

    // Personalize using centralized helper
    import('./js/firebase-user-helper.js').then(({ initUserPersonalization }) => {
      initUserPersonalization(async ({ user, helpers }) => {
        if (!user) return;
        const fullName = user.displayName || 'Student';
        const name = fullName.split(' ')[0];
        const topNameEl = document.getElementById('topName'); if (topNameEl) topNameEl.textContent = fullName;
        const userNameEl = document.getElementById('userName'); if (userNameEl) userNameEl.textContent = fullName;
        const badge = document.querySelector('.badge');
        if (badge && user.profile && user.profile.level) badge.textContent = user.profile.level;
        const userLevelEl = document.getElementById('userLevel');
        if (userLevelEl) {
          const l = (user && user.profile && user.profile.level) ? user.profile.level : '';
          userLevelEl.textContent = l && String(l).startsWith('SS') ? l : (l ? 'SS 3' : '');
        }
        const notifBadge = document.querySelector('.notification-badge');
        if (notifBadge && helpers && helpers.getUnreadNotificationsCount) notifBadge.textContent = String(await helpers.getUnreadNotificationsCount(user.uid));
        if (helpers && helpers.initialsFromName) {
          const initials = helpers.initialsFromName(user.displayName || name);
          const avatarEl = document.querySelector('.avatar');
          if (avatarEl) avatarEl.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=2563eb&color=fff&length=2`;
        }
      });
    }).catch(e => console.warn('firebase-user helper import failed', e));

    function addMessage(content, isUser = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
      
      const avatar = document.createElement('img');
      avatar.className = 'message-avatar';
      avatar.src = isUser ? 
        document.querySelector('.avatar').src :
        'https://ui-avatars.com/api/?name=AI&background=2563eb&color=fff';
      avatar.alt = isUser ? 'User' : 'AI';

      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = content;

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window)) {
        addMessage('Voice input requires a supported browser like Chrome. Please use text or switch browsers.');
        return;
      }
      try {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.onresult = (event) => {
          const query = event.results[0][0].transcript.trim();
          addMessage(query, true);
          askAI(query);
        };
        recognition.onerror = (event) => {
          addMessage(`Voice input failed: ${event.error}. Please try again or use text.`);
        };
        recognition.start();
      } catch (error) {
        addMessage('An error occurred with voice input. Please use text input instead.');
      }
    }

    async function fetchWebSummary(query) {
      const simulatedSources = [
        `Source 1: Information on ${query} suggests...`,
        `Source 2: Recent data indicates...`,
        `Source 3: Another perspective highlights...`
      ];
      return `Summary based on available information: ${query}. Key points from various sources: ${simulatedSources.join(' ')}.`;
    }

    // Add click handlers for suggestion chips
    document.querySelectorAll('.suggestion-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.getElementById('userInput').value = chip.textContent;
        askAI();
      });
    });

    async function askAI(query = null) {
      const input = document.getElementById('userInput');
      if (!query) query = input.value.trim();
      if (!query) return;
      if (!input.value) addMessage(query, true); // For voice input
      input.value = '';

      try {
        let prompt = `Provide a clear and concise answer to "${query}".`;
        if (chatHistory.length > 0 && chatHistory.some(prev => prev.query.toLowerCase().includes(query.toLowerCase()))) {
          prompt += ' Refer to prior discussions for context and add new details.';
        }
        if (query.toLowerCase().match(/richest|president|capital/i)) {
          prompt += ' Keep it factual and summarized, using the latest available data.';
        } else if (query.toLowerCase().includes('physics') || query.toLowerCase().includes('chemistry') || query.toLowerCase().includes('biology') || query.toLowerCase().includes('waec') || query.toLowerCase().includes('neco') || query.toLowerCase().includes('jamb')) {
          prompt += ' Explain like a teacher with step-by-step breakdown and a simple example, tailored for exam prep.';
        } else {
          prompt += ' Include a brief example if it clarifies the answer.';
        }

        const response = await fetch('/.netlify/functions/gemini', {
          method: 'POST',
          body: JSON.stringify({ prompt }),
        });
        
        const data = await response.json();
        let explanation = data.candidates[0]?.content.parts[0].text || 'I couldn’t find a direct answer. Let me search for more information.';
        if (explanation.includes('couldn’t fetch') || explanation.includes('try again')) {
          const webSummary = await fetchWebSummary(query);
          explanation = webSummary;
        }
        addMessage(explanation);
        chatHistory.push({ query, explanation });
      } catch (error) {
        console.error('Error:', error);
        addMessage('Sorry, there was an issue processing your request. Please try again later.');
      }
    }
  </script>
    <link rel="stylesheet" href="./dashboard-styles.css">
    <script>
      document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
    </script>
  </body>
</html>