<!doctype html>
<html lang="en">
  <head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Student Dashboard â€” Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div class="min-h-screen flex">
      <!-- Sidebar (canonical) -->
  <aside id="sidebar" class="w-64 md:w-72 lg:w-80 fixed left-0 top-0 h-full bg-white border-r border-slate-200 p-5 flex flex-col gap-6 transition-transform duration-300 ease-in-out overflow-auto z-40 lg:translate-x-0">
        <div class="flex items-center gap-3">
          <img src="/assets/images/logo.png" alt="logo" class="h-12 w-12 rounded-full shadow-sm">
          <div>
            <div class="text-lg font-bold text-sky-700">JUANOVA CORTEX</div>
            <div class="text-xs text-slate-500">Student Dashboard</div>
          </div>
        </div>

        <nav class="flex-1 overflow-auto">
          <ul class="space-y-1">
            <li><a href="student-dashboard.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-home text-sky-600"></i> Home</a></li>
            <li><a href="news-feed-gemini.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-newspaper text-pink-500"></i> News Feed</a></li>
            <li><a href="ai-tutor-chatbot.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-robot text-purple-500"></i> AI Tutor</a></li>
            <li><a href="study-plan.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-calendar-check text-green-500"></i> Study Plan</a></li>
            <li><a href="all-formula.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-book-open text-teal-600"></i> All Formula</a></li>
            <li><a href="video-library.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-video text-red-500"></i> Video Library</a></li>
            <li><a href="mock-exams.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-pencil-alt text-orange-500"></i> Mock Exams</a></li>
            <li><a href="notifications.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-bell text-pink-600"></i> Notifications</a></li>
            <li><a href="student-live-session.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-chalkboard-teacher text-blue-400"></i> Live Sessions</a></li>
            <li><a href="smart-note.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fas fa-sticky-note text-yellow-500"></i> Smart Notes</a></li>
          </ul>
        </nav>

        <div class="text-sm text-slate-500">
          <div class="mb-2">Account</div>
          <div class="flex items-center gap-3">
            <img id="avatar-sm" src="../assets/images/unnamed.jpg" alt="avatar" class="h-10 w-10 rounded-full border">
            <div>
              <div id="userName" class="font-semibold">Student</div>
              <div id="userLevel" class="text-xs text-slate-400"></div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main area -->
  <div id="main-content" class="flex-1 flex flex-col ml-64 md:ml-72 lg:ml-80">
        <!-- Topbar -->
        <header class="flex items-center justify-between p-4 bg-white border-b border-slate-200">
          <div class="flex items-center gap-3">
            <button id="toggleSidebar" class="p-2 rounded-md hover:bg-slate-100 lg:hidden" title="Toggle sidebar"><i class="fas fa-bars"></i></button>
            <div class="relative">
              <input id="globalSearch" type="search" placeholder="Search subjects, topics, resources..." class="w-[520px] hidden md:inline-block pl-10 pr-4 py-2 rounded-full border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-sky-100">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <div class="relative">
              <button id="notifBtn" class="p-2 rounded-full hover:bg-slate-50" aria-label="Notifications"><i class="fas fa-bell text-sky-600"></i></button>
              <span id="notifCount" class="absolute -top-1 -right-1 bg-pink-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right mr-2">
                <div id="topName" class="font-semibold">Student Name</div>
                <div id="topLevel" class="text-xs text-slate-400">SS 3</div>
              </div>
              <img id="topAvatar" src="../assets/images/unnamed.jpg" alt="avatar" class="h-10 w-10 rounded-full border-2">
            </div>
          </div>
        </header>

        <!-- Content -->
        <main class="p-6 space-y-6">
          <!-- Hero + Quick Stats -->
          <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-gradient-to-r from-sky-600 to-sky-500 text-white rounded-2xl p-6 shadow">
              <h2 class="text-2xl font-bold mb-1">Welcome back, <span id="heroName">Student</span> ðŸ‘‹</h2>
              <p id="heroMsg" class="opacity-90 mb-4">Let's make today productive â€” tasks loaded from your account.</p>
              <div class="flex gap-3">
                <a href="study-plan.html" class="bg-white/20 px-4 py-2 rounded-full font-medium hover:bg-white/30">Open Study Plan</a>
                <a href="mock-exams.html" class="bg-white/20 px-4 py-2 rounded-full font-medium hover:bg-white/30">Take a Mock Test</a>
                <a href="ai-tutor-chatbot.html" class="bg-white/20 px-4 py-2 rounded-full font-medium hover:bg-white/30">Chat with AI Tutor</a>
              </div>
            </div>

            <div class="bg-white rounded-2xl p-4 shadow flex flex-col gap-4">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-500">Weekly Progress</div>
                <div id="weeklyProgressLabel" class="text-sm font-semibold">0%</div>
              </div>
              <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden"><div id="weekBar" class="h-full bg-sky-500 w-0"></div></div>

              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-500">Mock Test Avg</div>
                <div id="mockAvgLabel" class="text-sm font-semibold">0%</div>
              </div>
              <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden"><div id="mockBar" class="h-full bg-yellow-400 w-0"></div></div>

              <div class="text-sm text-slate-500">Streak</div>
              <div id="streakLabel" class="text-lg font-bold">0 days</div>
            </div>
          </section>

          <!-- Subjects grid -->
          <section>
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold">Subjects</h3>
              <a href="subjects.html" class="text-sm text-sky-600">View all</a>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
              <a href="subjects/mathematics.html" class="bg-white rounded-2xl p-5 shadow hover:scale-105 transition text-center">
                <div class="text-2xl text-sky-500 mb-2"><i class="fas fa-square-root-alt"></i></div>
                <div class="font-semibold">Mathematics</div>
              </a>
              <a href="subjects/physics.html" class="bg-white rounded-2xl p-5 shadow hover:scale-105 transition text-center">
                <div class="text-2xl text-yellow-500 mb-2"><i class="fas fa-atom"></i></div>
                <div class="font-semibold">Physics</div>
              </a>
              <a href="subjects/chemistry.html" class="bg-white rounded-2xl p-5 shadow hover:scale-105 transition text-center">
                <div class="text-2xl text-pink-500 mb-2"><i class="fas fa-flask"></i></div>
                <div class="font-semibold">Chemistry</div>
              </a>
              <a href="subjects/biology.html" class="bg-white rounded-2xl p-5 shadow hover:scale-105 transition text-center">
                <div class="text-2xl text-green-500 mb-2"><i class="fas fa-dna"></i></div>
                <div class="font-semibold">Biology</div>
              </a>
              <a href="subjects/english.html" class="bg-white rounded-2xl p-5 shadow hover:scale-105 transition text-center">
                <div class="text-2xl text-indigo-500 mb-2"><i class="fas fa-book"></i></div>
                <div class="font-semibold">English</div>
              </a>
            </div>
          </section>

          <!-- Two column layout: Study plan + Activity -->
          <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow space-y-4">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold">Today â€” Study Plan</h4>
                <div id="taskCount" class="text-sm text-slate-400">0 tasks</div>
              </div>
              <ul id="todayTasks" class="space-y-3">
                <!-- Firestore tasks will populate here -->
              </ul>

              <div class="mt-4 flex gap-3">
                <button id="addTaskBtn" class="px-4 py-2 bg-sky-600 text-white rounded-full">Add Task</button>
                <button id="markCompleteAll" class="px-4 py-2 border rounded-full">Mark all complete</button>
              </div>
            </div>

            <aside class="bg-white rounded-2xl p-6 shadow space-y-4">
              <h4 class="font-semibold">Recent Activity</h4>
              <div id="activityFeed" class="space-y-3 text-sm text-slate-600">Loadingâ€¦</div>

              <hr>
              <h5 class="font-semibold">Upcoming Live Sessions</h5>
              <div id="upcoming" class="space-y-2 text-sm">Loadingâ€¦</div>
            </aside>
          </section>

        </main>

        <!-- Floating quick actions -->
        <div class="fixed bottom-8 right-8 flex flex-col gap-3 z-40">
          <button id="openAiChat" class="bg-purple-600 text-white px-4 py-3 rounded-full shadow-lg hover:scale-105 transition">Chat with AI</button>
          <button id="openNotes" class="bg-yellow-400 text-white px-4 py-3 rounded-full shadow-lg hover:scale-105 transition">Smart Notes</button>
        </div>

      </div>
    </div>

    <link rel="stylesheet" href="./dashboard-styles.css">

    <script type="module">
      // Firebase wiring, App Check and live Firestore reads for per-user data
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, doc, getDoc, collection, getDocs, query, where, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";
      import { firebaseConfig } from '../js/firebase-config.js';

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Initialize App Check only if recaptchaSiteKey is present in config
      if (firebaseConfig && firebaseConfig.recaptchaSiteKey) {
        try {
          initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider(firebaseConfig.recaptchaSiteKey),
            isTokenAutoRefreshEnabled: true
          });
          console.log('App Check initialized');
        } catch (err) {
          console.warn('App Check initialization failed:', err && err.message ? err.message : err);
        }
      } else {
        console.warn('App Check skipped: firebaseConfig.recaptchaSiteKey missing. Add your reCAPTCHA v3 site key to js/firebase-config.js to enable App Check.');
      }

      // Small helpers
      function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }
      function setImage(id, url) { const el = document.getElementById(id); if (el) el.src = url; }
      function showError(msg, time = 5000) {
        const toast = document.getElementById('error-toast'); const errorMsg = document.getElementById('error-message');
        if (toast && errorMsg) { errorMsg.textContent = msg; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), time); }
        else console.error(msg);
      }

      // Render helpers
      function renderTasksList(tasks) {
        const el = document.getElementById('todayTasks'); el.innerHTML = '';
        tasks.forEach(t => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between p-3 border rounded-lg';
          li.innerHTML = `<div class="flex items-center gap-3"><input type="checkbox" data-id="${t.id}" ${t.done? 'checked':''} class="h-4 w-4"><div><div class="font-medium">${t.title}</div><div class="text-xs text-slate-400">${t.due}</div></div></div><div><button data-id="${t.id}" class="text-slate-500 hover:text-sky-600">Start</button></div>`;
          el.appendChild(li);
        });
        setText('taskCount', `${tasks.length} tasks`);
      }

      function renderActivity(items) {
        const el = document.getElementById('activityFeed'); el.innerHTML='';
        if (!items.length) { el.textContent = 'No recent activity'; return; }
        items.forEach(i => {
          const d = document.createElement('div'); d.className='flex items-start gap-3'; d.innerHTML = `<div class="w-2 h-2 rounded-full bg-sky-500 mt-2"></div><div><div class="text-sm">${i.text}</div><div class="text-xs text-slate-400">${i.time || ''}</div></div>`; el.appendChild(d);
        });
      }

      function renderUpcoming(items) {
        const el = document.getElementById('upcoming'); el.innerHTML='';
        if (!items.length) { el.textContent = 'No upcoming sessions'; return; }
        items.forEach(u => {
          const row = document.createElement('div'); row.className='flex items-center justify-between';
          row.innerHTML = `<div><div class="font-medium">${u.title}</div><div class="text-xs text-slate-400">${u.time || ''}</div></div><div><a href="${u.link || '#'}" class="text-sky-600 text-sm">Join</a></div>`;
          el.appendChild(row);
        });
      }

  // Track current signed-in user id for writes
  let currentUid = null;

  // Firestore loaders
      async function loadTasks(uid) {
        try {
          const snap = await getDocs(collection(db, 'students', uid, 'tasks'));
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) { console.warn('loadTasks failed', e); return []; }
      }

      async function loadActivities(uid) {
        try {
          const snap = await getDocs(collection(db, 'students', uid, 'activities'));
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) { console.warn('loadActivities failed', e); return []; }
      }

      async function loadUpcoming(uid) {
        try {
          // primary: per-user subcollection
          let snap = await getDocs(collection(db, 'students', uid, 'upcomingSessions'));
          if (snap.size) return snap.docs.map(d => ({ id: d.id, ...d.data() }));
          // fallback: global sessions collection filtered by userId
          const q = query(collection(db, 'sessions'), where('userId', '==', uid));
          snap = await getDocs(q);
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) { console.warn('loadUpcoming failed', e); return []; }
      }

      async function loadNotificationCount(uid) {
        try {
          const q = query(collection(db, 'notifications'), where('userId', '==', uid), where('read', '==', false));
          const snap = await getDocs(q);
          return snap.size;
        } catch (e) { console.warn('loadNotificationCount failed', e); return 0; }
      }

      // Task create/update flows
      async function addTaskForUser(uid, { title, due }) {
        if (!uid) throw new Error('Not authenticated');
        if (!title || typeof title !== 'string' || title.trim().length < 3) throw new Error('Task title must be at least 3 characters');
        const payload = {
          title: title.trim(),
          due: due ? String(due) : '',
          done: false,
          createdAt: serverTimestamp()
        };
        const ref = await addDoc(collection(db, 'students', uid, 'tasks'), payload);
        return { id: ref.id, ...payload };
      }

      async function markAllTasksComplete(uid) {
        if (!uid) throw new Error('Not authenticated');
        const tasks = await loadTasks(uid);
        await Promise.all(tasks.map(t => updateDoc(doc(db, 'students', uid, 'tasks', t.id), { done: true, completedAt: serverTimestamp() }).catch(e => console.warn('update failed', e))));
      }

      async function updateTaskDone(uid, taskId, done) {
        if (!uid) throw new Error('Not authenticated');
        await updateDoc(doc(db, 'students', uid, 'tasks', taskId), { done: !!done, completedAt: done ? serverTimestamp() : null }).catch(e => console.warn('updateTaskDone failed', e));
      }

      // Auth state handling: when user logs in, load their personal data
      onAuthStateChanged(auth, async (u) => {
        if (!u) {
          // Not authenticated â€” show limited view
          setText('heroMsg', 'Please sign in to see your personalized dashboard.');
          return;
        }
        currentUid = u.uid;
        // Wire task UI events that require auth
        const addBtn = document.getElementById('addTaskBtn');
        if (addBtn) {
          addBtn.onclick = async () => {
            try {
              const title = prompt('Task title (required)');
              if (!title) return;
              const due = prompt('Due (optional, e.g. Today 5pm)') || '';
              await addTaskForUser(currentUid, { title, due });
              const refreshed = await loadTasks(currentUid);
              renderTasksList(refreshed);
            } catch (err) { showError(err.message || 'Failed to add task'); }
          };
        }

        const markAllBtn = document.getElementById('markCompleteAll');
        if (markAllBtn) {
          markAllBtn.onclick = async () => {
            try {
              await markAllTasksComplete(currentUid);
              const refreshed = await loadTasks(currentUid);
              renderTasksList(refreshed);
            } catch (err) { showError(err.message || 'Failed to mark tasks'); }
          };
        }

        // Handle task checkbox changes and Start button clicks via delegation
        const tasksContainer = document.getElementById('todayTasks');
        if (tasksContainer) {
          tasksContainer.addEventListener('change', async (ev) => {
            const tgt = ev.target;
            if (tgt && tgt.matches('input[type="checkbox"]')) {
              const taskId = tgt.closest('li')?.querySelector('button[data-id]')?.getAttribute('data-id') || tgt.getAttribute('data-id');
              const id = taskId || tgt.getAttribute('data-id');
              if (id) await updateTaskDone(currentUid, id, tgt.checked);
            }
          });
          tasksContainer.addEventListener('click', async (ev) => {
            const btn = ev.target.closest('button[data-id]');
            if (!btn) return;
            const id = btn.getAttribute('data-id');
            // Start -> toggle done to true
            try {
              await updateTaskDone(currentUid, id, true);
              const refreshed = await loadTasks(currentUid);
              renderTasksList(refreshed);
            } catch (err) { showError('Failed to start task'); }
          });
        }

        // set basic profile UI
  const displayName = u.displayName || 'Student';
  setText('userName', displayName);
  setText('topName', displayName);
  setText('heroName', (displayName.split && displayName.split(' ')[0]) || displayName);
          // prefer user photoURL, otherwise use initials avatar
          if (u.photoURL) {
            setImage('avatar-sm', u.photoURL);
            setImage('topAvatar', u.photoURL);
          } else {
            // get initials and set ui-avatars url via helper
            import('./js/firebase-user-helper.js').then(async ({ initialsFromName }) => {
              try {
                const initials = await initialsFromName(displayName);
                const url = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=2563eb&color=fff&length=2`;
                setImage('avatar-sm', url);
                setImage('topAvatar', url);
              } catch (e) {
                setImage('avatar-sm', '../assets/images/unnamed.jpg');
                setImage('topAvatar', '../assets/images/unnamed.jpg');
              }
            }).catch(()=>{
              setImage('avatar-sm', '../assets/images/unnamed.jpg');
              setImage('topAvatar', '../assets/images/unnamed.jpg');
            });
          }

        try {
          // attempt to load the students/{uid} profile
          const userDocSnap = await getDoc(doc(db, 'students', u.uid));
          const profile = userDocSnap.exists() ? userDocSnap.data() : {};
          setText('weeklyProgressLabel', (profile.weeklyProgress || 0) + '%');
          setText('mockAvgLabel', (profile.mockAvg || 0) + '%');
          setText('streakLabel', (profile.streak || 0) + ' days');

          // load live lists
          const [tasks, activities, upcoming, notifCount] = await Promise.all([
            loadTasks(u.uid),
            loadActivities(u.uid),
            loadUpcoming(u.uid),
            loadNotificationCount(u.uid)
          ]);

          renderTasksList(tasks);
          renderActivity(activities);
          renderUpcoming(upcoming);
          setText('notifCount', notifCount.toString());
        } catch (err) {
          console.error('Error loading user data:', err);
          showError('Failed to load your dashboard data.');
        }
      });

      // Sidebar toggle and quick actions
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      const toggleSidebarBtn = document.getElementById('toggleSidebar');
      const marginClasses = ['ml-64', 'md:ml-72', 'lg:ml-80'];

      toggleSidebarBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        sidebar.classList.toggle('-translate-x-full');
        if (sidebar.classList.contains('-translate-x-full')) {
          mainContent.classList.remove(...marginClasses);
        } else {
          mainContent.classList.add(...marginClasses);
        }
      });

      mainContent.addEventListener('click', () => {
        if (window.innerWidth < 1024 && !sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.add('-translate-x-full');
            mainContent.classList.remove(...marginClasses);
        }
      });

    </script>
  <!-- firebase-user import handled below in a safe dynamic import -->
    <script type="module">
      import('../js/firebase-user.js').then(({ onUserChange, getUnreadNotificationsCount, initialsFromName }) => {
        onUserChange(async (u) => {
          if (!u) return;
          const displayName = (u.profile && u.profile.displayName) || u.displayName || (u.profile && (u.profile.name || u.profile.fullName)) || u.email || 'Student';
          // set UI text
          const setTextEl = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
          const setImg = (id, src) => { const el = document.getElementById(id); if (el) el.src = src; };
          setTextEl('userName', displayName);
          setTextEl('topName', displayName);
          setTextEl('heroName', (displayName.split(' ')[0] || displayName));

          // avatar: prefer profile.photoURL or auth photoURL, otherwise initials
          const photo = (u.profile && u.profile.photoURL) || u.photoURL;
          if (photo) {
            setImg('avatar-sm', photo);
            setImg('topAvatar', photo);
          } else {
            const initials = initialsFromName(displayName || 'Student');
            const url = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=2563eb&color=fff&length=2`;
            setImg('avatar-sm', url);
            setImg('topAvatar', url);
          }

          // unread notifications count
          try {
            const count = await getUnreadNotificationsCount(u.uid);
            setTextEl('notifCount', String(count));
          } catch (e) { /* ignore */ }
        });
      }).catch(e => console.warn('firebase-user import failed', e));
    </script>
  </body>
</html>
